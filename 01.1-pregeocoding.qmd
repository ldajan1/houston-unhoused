---
title: "Geocoding"
format: html
---

## Goals of this notebook

1. Merge data sets
2. Prepare addresses for geocodio
3. Export

## Setup

Loading the libraries.

```{r}
#| label: setup
#| message: false
#| warning: false

library(tidyverse)
library(janitor)
library(readxl)
library(sf)
library(tidygeocoder)
```

## Importing

Data set 1.

```{r}
unhoused_raw_1 <- suppressWarnings(read_excel("data-raw/unhoused-raw-1.xlsx"))
```

Data set 2.

```{r}
unhoused_raw_2 <- suppressWarnings(read_excel("data-raw/unhoused-raw-2.xlsx"))
```

Data set 3.

```{r}
unhoused_raw_3 <- suppressWarnings(read_excel("data-raw/unhoused-raw-3.xlsx"))
```

## 1. Merging data sets

### 1.1 Evaluating merge readiness

Ensuring column names match.

```{r}
unhoused_raw_1 |> glimpse()
unhoused_raw_2 |> glimpse()
unhoused_raw_3 |> glimpse()
```

### 1.3 Cleaning names

#### 1.3.1 Data set 1

```{r}
unhoused_names_1 <- unhoused_raw_1 |> 
  clean_names()

unhoused_names_1 |> glimpse()
```

#### 1.3.2 Data set 2

```{r}
unhoused_names_2 <- unhoused_raw_2 |> 
  clean_names()

unhoused_names_2 |> glimpse()
```

### 1.3.3 Data set 3

```{r}
unhoused_names_3 <- unhoused_raw_3 |> 
  clean_names()

unhoused_names_3 |> glimpse()
```

### 1.4 Preparing to merge

#### 1.4.1 Data set 1

Fixing phone_number data type for data set 1, fixing misspellings and adding data_origin column to data set 1.

```{r}
unhoused_tidy_1 <- unhoused_names_1 |>
  mutate(phone_number = as.character(phone_number),
         data_origin = "unhoused_1"
         ) |> 
  rename(total_fine_amount_due = totla_fine_amount_due,
         total_fine_amount_paid = totla_fine_amount_paid,
         total_fine_amount_dismissed = totla_fine_amount_dismissed)

unhoused_tidy_1 |> glimpse()
```

#### 1.4.2 Data set 2

Adding data_origin column to data set 2 and renaming columns to match data set 1.

```{r}
unhoused_tidy_2 <- unhoused_names_2 |> 
  mutate(data_origin = "unhoused_2") |> 
  select(citation_number,
         case_number,
         offense_date,
         defendant_name,
         defendant_address,
         phone_number = defendant_phone_number,
         offense_location,
         violation_code,
         violation_description,
         total_fine_amount_due,
         total_fine_amount_paid,
         total_fine_amount_dismissed,
         judgment_date,
         judgment,
         disposition,
         data_origin
         )

unhoused_tidy_2 |> glimpse()
```

#### 1.4.3 Data set 3

Adding data_origin column to data set 2 and renaming columns to match the other data sets.

```{r}
unhoused_tidy_3 <- unhoused_names_3 |> 
  mutate(data_origin = "unhoused_3") |> 
  select(citation_number,
         case_number,
         offense_date,
         defendant_name,
         defendant_address,
         phone_number = defendant_phone_number,
         offense_location,
         violation_code,
         violation_description,
         total_fine_amount_due,
         total_fine_amount_paid,
         total_fine_amount_dismissed,
         judgment_date,
         judgment,
         disposition,
         data_origin
         )

unhoused_tidy_3 |> glimpse()
```

### 1.5 Merging sheets

Merging sheets.

```{r}
unhoused_merged <- bind_rows(unhoused_tidy_1, unhoused_tidy_2, unhoused_tidy_3)

unhoused_merged |> glimpse()
```

## 2. Preparing to geocode

Reformatting addresses to prepare to geocode externally using geocodeio

```{r}
unhoused_geo_prep <- unhoused_merged |>
  mutate(full_address = paste(str_remove(offense_location, ","),
                              "Houston, TX", sep = ", "))

unhoused_geo_prep 
```

## 3. Exporting pre-geocode

Exporting the data to geocode externally.

```{r}
unhoused_geo_prep |>
  write_csv("data-processed/unhoused-pregeocoded.csv")
```
